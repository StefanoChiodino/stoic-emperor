{% extends "base.html" %}

{% block title %}Analysis - Stoic Emperor{% endblock %}

{% block content %}
<div class="p-6 border-b border-white/10 bg-black/20">
    <h2 class="text-xl text-gold-500">Psychological Profile</h2>
    <p class="text-sm text-gray-500 mt-1">Deep analysis generated automatically as you converse.</p>
</div>

<div class="flex-1 overflow-y-auto p-8">
    <div class="max-w-3xl mx-auto">
        <div id="progress-section" class="mb-6 p-4 bg-black/20 rounded-lg border border-white/10">
            <div class="flex justify-between text-sm text-gray-400 mb-2">
                <span>Memory condensation</span>
                <span id="progress-text"><span class="loading-indicator inline-flex"><span></span><span></span><span></span></span></span>
            </div>
            <div class="w-full h-2 bg-white/10 rounded-full overflow-hidden">
                <div id="progress-bar" class="h-full bg-gold-500 transition-all duration-300" style="width: 0%"></div>
            </div>
            <div id="summary-count" class="text-xs text-gray-500 mt-2"></div>
        </div>

        <div id="profile-content">
            <div class="text-center py-20 text-gray-500">
                <h3 class="text-xl text-gray-400 mb-2">No profile yet</h3>
                <p>Continue chatting with Marcus Aurelius. Your profile will be generated automatically.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function loadAnalysisStatus() {
        try {
            const headers = await getAuthHeaders();
            const response = await fetch('/api/analysis/status', { headers });
            const status = await response.json();

            const progress = Math.min(100, Math.round((status.uncondensed_tokens / status.condensation_threshold) * 100));
            document.getElementById('progress-text').textContent =
                `${status.uncondensed_tokens.toLocaleString()} / ${status.condensation_threshold.toLocaleString()} tokens`;
            document.getElementById('progress-bar').style.width = `${progress}%`;
            document.getElementById('summary-count').textContent =
                status.summary_count > 0 ? `${status.summary_count} condensed summaries` : '';
        } catch (error) {
            console.error('Failed to load analysis status:', error);
        }
    }

    async function loadProfile() {
        try {
            const headers = await getAuthHeaders();
            const response = await fetch('/api/profile', { headers });
            const container = document.getElementById('profile-content');

            if (response.status === 200) {
                const profile = await response.json();
                if (profile) {
                    const consensusHtml = profile.consensus_reached !== null
                        ? `<span class="${profile.consensus_reached ? 'text-green-400' : 'text-orange-400'}">${profile.consensus_reached ? 'Consensus' : 'No consensus'}</span>`
                        : '';
                    const stabilityHtml = profile.stability_score !== null
                        ? ` | Stability: ${profile.stability_score.toFixed(2)}`
                        : '';

                    container.innerHTML = `
                        <div class="mb-4 p-3 bg-black/30 rounded-lg text-xs text-gray-500">
                            Version ${profile.version} | ${formatDate(profile.created_at)}
                            ${consensusHtml ? ' | ' + consensusHtml : ''}${stabilityHtml}
                        </div>
                        <div class="prose prose-invert prose-gold max-w-none">
                            ${renderMarkdown(profile.content)}
                        </div>
                    `;
                    return;
                }
            }
            container.innerHTML = `
                <div class="text-center py-20 text-gray-500">
                    <h3 class="text-xl text-gray-400 mb-2">No profile yet</h3>
                    <p>Continue chatting with Marcus Aurelius. Your profile will be generated automatically.</p>
                </div>
            `;
        } catch (error) {
            console.error('Failed to load profile:', error);
        }
    }

    function renderMarkdown(text) {
        return text
            .replace(/^### (.*$)/gm, '<h3 class="text-lg text-gold-500 mt-6 mb-2">$1</h3>')
            .replace(/^## (.*$)/gm, '<h2 class="text-xl text-gold-500 mt-6 mb-3">$1</h2>')
            .replace(/^# (.*$)/gm, '<h1 class="text-2xl text-gold-500 mt-6 mb-3">$1</h1>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/^- (.*$)/gm, '<li class="ml-4">$1</li>')
            .replace(/\n\n/g, '</p><p class="mb-3">')
            .replace(/^(?!<[hlo])/gm, '<p class="mb-3">')
            .replace(/<p class="mb-3"><\/p>/g, '');
    }

    function formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString(undefined, {
            year: 'numeric', month: 'short', day: 'numeric'
        });
    }

    document.addEventListener('DOMContentLoaded', async () => {
        await new Promise(r => setTimeout(r, 100));
        await loadAnalysisStatus();
        await loadProfile();
    });
</script>
{% endblock %}
