{% extends "base.html" %}

{% block title %}Chat - Stoic Emperor{% endblock %}

{% block content %}
<div class="p-6 border-b border-white/10 bg-black/20">
    <h2 class="text-xl text-gold-500">Marcus Aurelius</h2>
    <p class="text-sm text-gray-500 mt-1">Stoic philosopher and Roman Emperor. Share your thoughts.</p>
</div>

<div id="messages" class="flex-1 overflow-y-auto p-8 space-y-6">
    <div class="text-center py-20 text-gray-500">
        <span class="loading-indicator justify-center"><span></span><span></span><span></span></span>
    </div>
</div>

<div id="loading" class="hidden max-w-3xl mx-auto mb-6 p-5 bg-gold-500/10 border-l-4 border-gold-500 rounded-xl">
    <div class="text-xs uppercase tracking-wide text-gold-500 mb-2">Marcus Aurelius</div>
    <div class="loading-dots flex gap-1.5">
        <span class="w-2 h-2 bg-gold-500 rounded-full"></span>
        <span class="w-2 h-2 bg-gold-500 rounded-full"></span>
        <span class="w-2 h-2 bg-gold-500 rounded-full"></span>
    </div>
</div>

<div class="p-6 bg-black/30 border-t border-white/10">
    <form id="chat-form" class="max-w-3xl mx-auto flex gap-3">
        <textarea
            id="message-input"
            name="message"
            placeholder="Share your thoughts..."
            rows="1"
            class="flex-1 px-4 py-4 bg-white/5 border border-white/15 rounded-xl text-gray-200 resize-none focus:outline-none focus:border-gold-500 placeholder-gray-600"
            onkeydown="handleKeydown(event)"
            oninput="autoResize(this)"
        ></textarea>
        <button type="submit" class="px-6 py-4 bg-gold-500 text-dark-800 font-semibold rounded-xl hover:bg-gold-400 transition self-end disabled:opacity-50 disabled:cursor-not-allowed">
            Send
        </button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    window.currentSessionId = window.currentSessionId || null;

    function showLoading() {
        document.getElementById('loading').classList.remove('hidden');
    }

    function hideLoading() {
        document.getElementById('loading').classList.add('hidden');
    }

    function handleKeydown(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            document.getElementById('chat-form').requestSubmit();
        }
    }

    function autoResize(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
    }

    function addMessage(role, content) {
        const container = document.getElementById('messages');
        const emptyState = container.querySelector('.text-center');
        if (emptyState) emptyState.remove();

        const roleClass = role === 'user'
            ? 'bg-white/5 ml-20'
            : 'bg-gold-500/10 border-l-4 border-gold-500';
        const labelClass = role === 'user' ? 'text-gray-500' : 'text-gold-500';
        const label = role === 'user' ? 'You' : 'Marcus Aurelius';

        const div = document.createElement('div');
        div.className = `max-w-3xl mx-auto p-5 rounded-xl ${roleClass}`;
        div.innerHTML = `
            <div class="text-xs uppercase tracking-wide ${labelClass} mb-2">${label}</div>
            <div class="leading-relaxed whitespace-pre-wrap">${escapeHtml(content)}</div>
        `;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
        return div;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    document.getElementById('chat-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const input = document.getElementById('message-input');
        const message = input.value.trim();
        if (!message) return;

        input.value = '';
        input.style.height = 'auto';
        localStorage.removeItem('chat_draft');
        const userMsgEl = addMessage('user', message);
        showLoading();

        try {
            const headers = await getAuthHeaders();
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', ...headers },
                body: JSON.stringify({ message, session_id: window.currentSessionId })
            });
            if (!response.ok) throw new Error('Request failed');
            const data = await response.json();
            window.currentSessionId = data.session_id;
            addMessage('emperor', data.response);
        } catch (error) {
            console.error('Chat error:', error);
            userMsgEl.remove();
            input.value = message;
            autoResize(input);
            showError('Failed to send. Your message is preservedâ€”please try again.');
        } finally {
            hideLoading();
        }
    });

    function showError(text) {
        let el = document.getElementById('chat-error');
        if (!el) {
            el = document.createElement('div');
            el.id = 'chat-error';
            el.className = 'max-w-3xl mx-auto mb-4 p-3 bg-red-500/15 border border-red-500/30 text-red-400 rounded-lg text-sm';
            document.getElementById('chat-form').parentNode.insertBefore(el, document.getElementById('chat-form'));
        }
        el.textContent = text;
        el.classList.remove('hidden');
        setTimeout(() => el.classList.add('hidden'), 5000);
    }

    const input = document.getElementById('message-input');
    input.addEventListener('input', () => {
        if (input.value.trim()) {
            localStorage.setItem('chat_draft', input.value);
        } else {
            localStorage.removeItem('chat_draft');
        }
    });

    const savedDraft = localStorage.getItem('chat_draft');
    if (savedDraft) {
        input.value = savedDraft;
        autoResize(input);
    }

    async function loadLatestSession() {
        const container = document.getElementById('messages');
        container.innerHTML = '<div class="text-center py-20 text-gray-500"><span class="loading-indicator justify-center"><span></span><span></span><span></span></span></div>';

        try {
            const headers = await getAuthHeaders();
            const response = await fetch('/api/sessions', { headers });
            if (!response.ok) {
                showEmptyState();
                return;
            }

            const sessions = await response.json();
            if (sessions.length === 0) {
                showEmptyState();
                return;
            }

            const latest = sessions[0];
            window.currentSessionId = latest.id;

            if (latest.message_count > 0) {
                const msgResponse = await fetch(`/api/sessions/${latest.id}/messages`, { headers });
                if (msgResponse.ok) {
                    const messages = await msgResponse.json();
                    container.innerHTML = '';
                    messages.forEach(m => addMessage(m.role, m.content));
                    return;
                }
            }
            showEmptyState();
        } catch (error) {
            console.error('Failed to load session:', error);
            showEmptyState();
        }
    }

    function showEmptyState() {
        document.getElementById('messages').innerHTML = `
            <div class="text-center py-20 text-gray-500">
                <h3 class="text-2xl text-gray-400 mb-2">Begin Your Dialogue</h3>
                <p>Share what's on your mind with the Stoic Emperor.</p>
            </div>
        `;
    }

    document.addEventListener('DOMContentLoaded', async () => {
        await new Promise(r => setTimeout(r, 100));
        await loadLatestSession();
    });
</script>
{% endblock %}
